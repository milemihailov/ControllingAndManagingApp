@page "/connection"
@page "/"
@using MachineControlHub.PrinterConnection
@inject Data.BackgroundTimer background
@inject Data.PrinterDataServiceTest printer

<PageTitle>Serial Connection</PageTitle>
<ConnectionStatus SelectedPrinter="@printer.SelectedPrinter.Name" Connection="background.ConnectionServiceSerial.printerConnection.IsConnected" />

<MudPaper Height="500px" Width="100%" Elevation="0" Class="pt-10">
    <MudContainer MaxWidth="MaxWidth.Small">
        <MudPaper Style="display: flex; justify-content:center;" Class="pt-2" Elevation="0">
            <MudButton Color="Color.Tertiary" @onclick="ConnectionConfiguration" > Connect</MudButton>
            <MudButton Color="Color.Error" @onclick="background.ConnectionServiceSerial.Disconnect"> Disconnect</MudButton>
        </MudPaper>
    </MudContainer>

    <MudContainer MaxWidth="MaxWidth.ExtraSmall">
        <MudPaper Style="display: flex; justify-content: center;" class="pt-2" Elevation="0">
            <MudSelect T="string" Label="Select Port" @bind-Value="background.ConnectionServiceSerial.portName" Variant="Variant.Outlined">
                @foreach (var template in background.ConnectionServiceSerial.GetPorts())
                {
                    <MudSelectItem Value=@template />
                }
            </MudSelect>
        </MudPaper>
    </MudContainer>
    <MudContainer MaxWidth="MaxWidth.ExtraSmall">
        <MudPaper Style="display: flex; justify-content: center;" class="pt-2" Elevation="0">
            <MudSelect T="int" Label="Select Baudrate" @bind-Value="background.ConnectionServiceSerial.baudRate" Variant="Variant.Outlined">
                <MudSelectItem Value="115200" />
                <MudSelectItem Value="250000" />
            </MudSelect>
        </MudPaper>
    </MudContainer>
</MudPaper>

@code {

    public void ConnectionConfiguration()
    {
        try
        {
            background.ConnectionServiceSerial.Initialize($"{background.ConnectionServiceSerial.portName},{background.ConnectionServiceSerial.baudRate}");
            background.ConnectionServiceSerial.IsConnected = true;
            background.ConnectionServiceSerial.Connect();
            background.SavePortName();
            printer.GetPrinterSettings();
            printer.GetFirmwareSettings();
            //set the host keep alive command to 1 second after connection
            background.ConnectionServiceSerial.Write("M113 S1");
            //ask for bed volume
            background.ConnectionServiceSerial.Write("M211");
            //Report SD status every 2 seconds
            background.ConnectionServiceSerial.Write("M27 S2");
            //report temperature every 1 seconds
            background.ConnectionServiceSerial.Write("M155 S1");
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }
}
